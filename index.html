<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…. Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --gold: #ffcc00; --green: #00f2fe; --blue: #00d2ff; --bg: #030508;
            --card-bg: rgba(15, 18, 25, 0.95); --red: #ff4b2b; --purple: #a18cd1;
        }

        body {
            background: var(--bg);
            background-image: radial-gradient(circle at center, #111827, #030508);
            color: white; font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; padding: 20px; min-height: 100vh;
        }

        .container {
            max-width: 1500px; margin: auto;
            background: var(--card-bg); backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9);
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.05);
            padding-bottom: 20px;
        }

        .title-area h2 {
            margin: 0; font-size: 30px; font-weight: 900;
            background: linear-gradient(to left, var(--gold), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .button-group { display: flex; gap: 10px; }
        
        .btn {
            padding: 12px 22px; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 700; font-size: 13px;
            transition: 0.3s; display: flex; align-items: center; gap: 8px; color: white;
        }

        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        .btn-up { background: #eeeeee; color: #000; }
        .btn-design { background: linear-gradient(135deg, #00b09b, #96c93d); }
        .btn-ngl { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .btn-pdf { background: linear-gradient(135deg, #6a11cb, #2575fc); border: 1px solid rgba(255,255,255,0.2); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .card {
            background: rgba(0, 0, 0, 0.7); border-radius: 15px; padding: 25px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        h4 { margin: 0 0 15px 0; color: var(--gold); font-size: 18px; border-right: 4px solid var(--gold); padding-right: 10px; }

        #map { height: 420px; border-radius: 12px; border: 1px solid #444; }
        
        .coords-panel {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
        }
        .coord-box {
            background: #111; padding: 10px; border-radius: 8px; border: 1px solid #222; font-size: 11px;
        }
        .coord-box b { color: var(--green); display: block; font-size: 14px; margin-top: 3px; font-family: monospace; }

        canvas { 
            width: 100%; height: 420px; background: #000; border-radius: 12px; 
            border: 1px solid #1a1a1a;
        }

        .table-container { grid-column: span 2; max-height: 350px; overflow-y: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { background: #0a0a0a; color: var(--gold); padding: 15px; font-size: 13px; position: sticky; top: 0; border-bottom: 2px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #1a1a1a; font-size: 12px; background: #050505; }
        .design-text { color: var(--green); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title-area">
            <h2>ğŸ—ï¸ Ù…. Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ</h2>
            <div style="color: var(--gold); font-size: 13px; font-weight: 500;">Ø¥Ø´Ø±Ø§Ù Ù‡Ù†Ø¯Ø³ÙŠ Ù…ÙŠØ¯Ø§Ù†ÙŠ</div>
        </div>
        <div class="button-group">
            <button class="btn btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“‚ Ø±ÙØ¹ NGL</button>
            <button class="btn btn-design" onclick="exportSCR('design')">âš¡ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØµÙ…ÙŠÙ…ÙŠ</button>
            <button class="btn btn-ngl" onclick="exportSCR('ngl')">âš¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø¶</button>
            <button class="btn btn-pdf" onclick="openSahabyCV()">ğŸ‘¤ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</button>
        </div>
        <input type="file" id="fileIn" style="display:none" onchange="processNGL(this)">
    </div>

    <div class="grid">
        <div class="card">
            <h4>ğŸ“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‡Ø¬ÙŠÙ†Ø© (ØµÙˆØ± + Ù…Ø¹Ø§Ù„Ù… Ù…ÙƒØ«ÙØ©)</h4>
            <div id="map"></div>
            <div class="coords-panel">
                <div class="coord-box">WGS84 (Lat/Lon): <b id="gCoord">--- , ---</b></div>
                <div class="coord-box">Civil 3D (X/Y): <b id="cCoord">--- , ---</b></div>
            </div>
            <button class="btn" style="width:100%; margin-top:15px; justify-content:center; background: var(--blue);" onclick="activateGPS()">ğŸ“¡ Ø±ØµØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ</button>
        </div>

        <div class="card">
            <h4>ğŸ“ˆ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø·ÙˆÙ„ÙŠ (ÙˆØ¶ÙˆØ­ Ø¹Ø§Ù„ÙŠ)</h4>
            <canvas id="profileCanvas"></canvas>
            <div style="display: flex; gap: 20px; font-size: 11px; margin-top: 10px; justify-content: center;">
                <span style="color: var(--gold);">--- Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©</span>
                <span style="color: var(--green);">â€”â€” Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ (Ù‡Ù†Ø¯Ø³ÙŠ)</span>
            </div>
        </div>

        <div class="table-container card">
            <h4>ğŸ“‹ ÙƒØ´Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©</h4>
            <table>
                <thead>
                    <tr>
                        <th>#</th><th>X (NGL)</th><th>Y (NGL)</th><th>Z (NGL)</th>
                        <th class="design-text">X (Design)</th><th class="design-text">Y (Design)</th><th class="design-text">Z (Design)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" style="padding:40px; opacity:0.3;">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let pts = [], map, marker;

    function openSahabyCV() {
        window.open("Quantity Surveyor mahmoud ali elsayed shaby hammad.pdf", "_blank");
    }

    function processNGL(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/);
            pts = lines.map((line) => {
                const d = line.trim().split(/[, \s\t]+/);
                if (d.length >= 4) {
                    let n = parseFloat(d[1]); 
                    let e = parseFloat(d[2]); 
                    let z = parseFloat(d[3]);
                    if(!isNaN(e) && !isNaN(n)) {
                        return { id: d[0], e: e, n: n, z: z, zD: z, de: e, dn: n };
                    }
                }
            }).filter(p => p);
            if (pts.length) { 
                calculateIdealPath(); 
                updateDisplay(); 
                initMap(pts[0].n, pts[0].e);
            }
        };
        reader.readAsText(input.files[0]);
    }

    function calculateIdealPath() {
        const n = pts.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            sumX += i; sumY += pts[i].z;
            sumXY += i * pts[i].z; sumX2 += i * i;
        }
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        pts.forEach((p, i) => {
            p.zD = intercept + slope * i;
            p.de = p.e; p.dn = p.n;
        });
    }

    function updateDisplay() {
        document.getElementById('tableBody').innerHTML = pts.map(p => `
            <tr>
                <td>${p.id}</td><td>${p.e.toFixed(2)}</td><td>${p.n.toFixed(2)}</td><td>${p.z.toFixed(2)}</td>
                <td class="design-text">${p.de.toFixed(3)}</td><td class="design-text">${p.dn.toFixed(3)}</td><td class="design-text">${p.zD.toFixed(3)}</td>
            </tr>
        `).join('');
        drawProfile();
    }

    function drawProfile() {
        const cvs = document.getElementById('profileCanvas'), ctx = cvs.getContext('2d');
        cvs.width = cvs.offsetWidth; cvs.height = 420;
        let zs = [...pts.map(p => p.z), ...pts.map(p => p.zD)];
        let min = Math.min(...zs)-1, max = Math.max(...zs)+1, rng = max-min;
        
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.lineWidth = 0.5;
        for(let j=0; j<=10; j++) {
            let y = (j/10)*cvs.height;
            ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cvs.width,y); ctx.stroke();
        }

        ctx.strokeStyle = "rgba(255, 204, 0, 0.4)"; ctx.setLineDash([8,4]); ctx.lineWidth = 2;
        ctx.beginPath();
        pts.forEach((p, i) => {
            let x = (i/pts.length)*cvs.width, y = cvs.height - ((p.z-min)/rng)*cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }); ctx.stroke();

        ctx.strokeStyle = "#00f2fe"; ctx.setLineDash([]); ctx.lineWidth = 6;
        ctx.shadowBlur = 15; ctx.shadowColor = "#00f2fe";
        ctx.beginPath();
        pts.forEach((p, i) => {
            let x = (i/pts.length)*cvs.width, y = cvs.height - ((p.zD-min)/rng)*cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }); ctx.stroke();
    }

    function initMap(lat, lon) {
        if(!map) {
            map = L.map('map').setView([lat, lon], 17);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
            L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);
            L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}').addTo(map);
        }
    }

    function activateGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            if(map) map.setView([latitude, longitude], 19);
            if(marker) map.removeLayer(marker);
            marker = L.marker([latitude, longitude]).addTo(map).bindPopup("Ø±ØµØ¯ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ÙˆÙ‚Ø¹").openPopup();
            document.getElementById('gCoord').innerText = latitude.toFixed(7) + " , " + longitude.toFixed(7);
        });
    }

    function exportSCR(type) {
        if(!pts.length) return alert("Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
        let data = (type === 'design') ? pts.map(p => `${p.de.toFixed(3)},${p.dn.toFixed(3)},${p.zD.toFixed(3)}`) : pts.map(p => `${p.e.toFixed(3)},${p.n.toFixed(3)},${p.z.toFixed(3)}`);
        let cmd = (type === 'design') ? '3DPOLY' : 'PLINE';
        let scr = `UNDO BE\nCOLOR ${type=='design'?3:2}\n${cmd}\n${data.join("\n")}\n\nZOOM E\nUNDO END\n`;
        const blob = new Blob([scr], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = type + "_Mahmoud_Sahaby.scr"; a.click();
    }
</script>
</body>
</html>
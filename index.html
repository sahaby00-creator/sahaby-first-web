<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³ÙŠØ¯Ùˆ Ø­Ø³Ø§Ø¨ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© - Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</title>

  <!-- Leaflet & html2canvas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --gold: #ffc600;
      --green: #00f2fe;
      --blue: #004dff;
      --bg: #003508;
      --card-bg: rgba(15, 18, 25, 0.95);
      --red: #ff4b2b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1500px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 15px;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
      font-size: 13px;
    }

    .btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    .btn-up {
      background: #00eec7;
      color: #000;
    }

    .btn-cv {
      background: linear-gradient(135deg, #6101bc, #2575fc);
    }

    .btn-design {
      background: linear-gradient(135deg, #00b8b9, #96c93d);
    }

    .btn-ngl {
      background: linear-gradient(135deg, #ff446c, #ff4b2b);
    }

    .btn-report {
      background: #222;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .card {
      background: rgba(0, 0, 0, 0.8);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid #222;
    }

    h4 {
      margin: 0 0 15px 0;
      color: var(--gold);
      border-bottom: 4px solid var(--gold);
      padding-right: 10px;
      font-size: 16px;
    }

    #map {
      height: 400px;
      border-radius: 12px;
    }

    canvas {
      width: 100%;
      height: 400px;
      background: #000;
      border-radius: 12px;
    }

    .table-container {
      grid-column: span 2;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      font-size: 13px;
    }

    th {
      background: #111;
      color: var(--gold);
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #111;
    }

    .design-val {
      color: var(--green);
      font-weight: bold;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      opacity: 0.7;
      text-align: center;
    }
  </style>
</head>
<body id="reportArea">

<div class="container">

  <div class="header">
    <div class="title-area">
      <h2 style="margin:0; color:var(--gold)">E - Ø³ÙŠØ¯Ùˆ Ø­Ø³Ø§Ø¨ÙŠ</h2>
      <div style="font-size: 12px; opacity: 0.8;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© - Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</div>
      <div style="font-size: 12px; opacity: 0.8;">Ù…. Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ</div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù NGL</button>
      <button class="btn btn-design" onclick="exportSCR('design')">ğŸ“œ SCR Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Design)</button>
      <button class="btn btn-ngl" onclick="exportSCR('NGL')">ğŸ“œ SCR NGL</button>
      <button class="btn btn-cv" onclick="openCV()">ğŸ“‘ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
      <button class="btn btn-report" onclick="generateReport()">ğŸ“¸ ØªÙ‚Ø±ÙŠØ± ØµÙˆØ±Ø©</button>
    </div>
  </div>

  <input type="file" id="fileIn" style="display:none" onchange="processFile(this)" />

  <div class="grid">

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ -->
    <div class="card">
      <h4>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ù„</h4>
      <canvas id="profileCanvas"></canvas>
      <div style="text-align:center; margin-top:10px; font-size:12px;">
        <span style="color:var(--gold)">Ø²Ù…Ù† Ø·Ø¨ÙŠØ¹ÙŠ</span> |
        <span style="color:var(--green)">â€”â€” Ù…Ø³Ø§Ø± ØªØµÙ…ÙŠÙ…ÙŠ</span>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© GPS -->
    <div class="card">
      <h4>Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚ (GPS)</h4>
      <div id="map"></div>
      <button class="btn" style="width:100%; margin-top:10px; background:var(--blue); justify-content:center"
              onclick="activateGPS()">ğŸ“¡ Ø±ØµØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ù…Ø­ÙŠØ·Ø©</button>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· -->
    <div class="table-container card">
      <h4>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·</h4>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>E (Ø´Ø±Ù‚)</th>
            <th>N (Ø´Ù…Ø§Ù„)</th>
            <th>Z (NGL)</th>
            <th class="design-val">Z (Design)</th>
            <th>Ø§Ù„ÙØ±Ù‚ (Ù…)</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="6" style="padding:40px; opacity:0.3;">... Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <div class="footer-note">
    Ù†Ø³Ø®Ø© Ø¹Ø±Ø¶ Ù‡Ù†Ø¯Ø³ÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ© - Sahaby Geo Profile
  </div>

</div>
<script>

  let pts = [];
  let map;

  function speak(text) {
    try {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "ar-SA";
      window.speechSynthesis.speak(msg);
    } catch(e) {}
  }

  /* ---------------------------------------------------------
     ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù‡Ù†Ø§ â€” Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙÙƒ Ø¨ØµÙŠØºØ© (E,N,Z)
     --------------------------------------------------------- */
  function processFile(input) {
    const reader = new FileReader();

    reader.onload = (e) => {
      pts = e.target.result
        .split(/\r?\n/)
        .map((line, index) => {
          if (!line.trim()) return null;

          // ØªÙ‚Ø³ÙŠÙ… Ø¨Ø£ÙŠ ÙØ§ØµÙ„: Ù…Ø³Ø§ÙØ© / ÙØ§ØµÙ„Ø© / Ø³ÙŠÙ…ÙŠ ÙƒÙˆÙ„ÙˆÙ† / ØªØ§Ø¨
          const d = line.trim().split(/[\s,;]+/);

          if (d.length < 3) return null;

          return {
            id: index + 1,
            e: parseFloat(d[0]),
            n: parseFloat(d[1]),
            z: parseFloat(d[2])
          };
        })
        .filter(p => p && !isNaN(p.z));

      if (pts.length) {
        calculateLogic();
        updateUI();
        speak("ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶.");
      } else {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.");
      }
    };

    reader.readAsText(input.files[0]);
  }

  /* ---------------------------------------------------------
     ğŸ”· Ø­Ø³Ø§Ø¨ Ø®Ø· Ø§Ù„ØªØµÙ…ÙŠÙ… (Regression Line)
     --------------------------------------------------------- */
  function calculateLogic() {
    const n = pts.length;
    let sX = 0, sY = 0, sXY = 0, sX2 = 0;

    pts.forEach((p, i) => {
      sX += i;
      sY += p.z;
      sXY += i * p.z;
      sX2 += i * i;
    });

    const denom = (n * sX2 - sX * sX) || 1;
    const slope = (n * sXY - sX * sY) / denom;
    const intercept = (sY - slope * sX) / n;

    pts.forEach((p, i) => {
      p.zD = intercept + slope * i;
      p.diff = p.z - p.zD;
    });
  }

  /* ---------------------------------------------------------
     ğŸ”· ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
     --------------------------------------------------------- */
  function updateUI() {
    const body = document.getElementById('tableBody');

    body.innerHTML = pts.map(p =>
      `<tr>
        <td>${p.id}</td>
        <td>${p.e.toFixed(3)}</td>
        <td>${p.n.toFixed(3)}</td>
        <td>${p.z.toFixed(3)}</td>
        <td class="design-val">${p.zD.toFixed(3)}</td>
        <td>${p.diff.toFixed(3)}</td>
      </tr>`
    ).join('');

    drawChart();
  }

  /* ---------------------------------------------------------
     ğŸ”· Ø±Ø³Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Canvas)
     --------------------------------------------------------- */
  function drawChart() {
    const cvs = document.getElementById('profileCanvas');
    const ctx = cvs.getContext('2d');

    cvs.width = cvs.offsetWidth;
    cvs.height = 400;

    if (!pts.length) {
      ctx.clearRect(0, 0, cvs.width, cvs.height);
      return;
    }

    const z = pts.map(p => p.z);
    const zD = pts.map(p => p.zD);

    let min = Math.min(...zD, ...z);
    let max = Math.max(...zD, ...z);
    let rng = max - min || 1;

    ctx.clearRect(0, 0, cvs.width, cvs.height);

    // Ø®Ø· Ø§Ù„ØªØµÙ…ÙŠÙ…
    ctx.strokeStyle = "#ffcc00";
    ctx.setLineDash([5]);
    ctx.lineWidth = 2;
    ctx.beginPath();

    pts.forEach((p, i) => {
      let x = (i / (pts.length - 1 || 1)) * cvs.width;
      let y = 400 - ((p.zD - min) / rng) * 400;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();

    // Ø®Ø· Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©
    ctx.strokeStyle = "#00ffee";
    ctx.setLineDash([]);
    ctx.lineWidth = 4;
    ctx.shadowBlur = 10;
    ctx.shadowColor = "#00ffee";
    ctx.beginPath();

    pts.forEach((p, i) => {
      let x = (i / (pts.length - 1 || 1)) * cvs.width;
      let y = 400 - ((p.z - min) / rng) * 400;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  /* ---------------------------------------------------------
     ğŸ”· GPS
     --------------------------------------------------------- */
  function activateGPS() {
    if (!map) {
      map = L.map('map').setView([24.7, 46.6], 18);

      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
        .addTo(map);

      L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}')
        .addTo(map);

      L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}')
        .addTo(map);
    }

    speak("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ù…Ø­ÙŠØ·Ø©");

    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      map.setView([lat, lng], 19);
      L.marker([lat, lng]).addTo(map).bindPopup("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØ§Ù†").openPopup();
    });
  }

  /* ---------------------------------------------------------
     ğŸ”· ÙØªØ­ Ù…Ù„Ù CV
     --------------------------------------------------------- */
  function openCV() {
    window.open("Quantity Surveyor mahmoud ali elsayed shaby hammad.pdf", "_blank");
  }

  /* ---------------------------------------------------------
     ğŸ”· ØªØµØ¯ÙŠØ± SCR
     --------------------------------------------------------- */
  function exportSCR(type) {
    if (!pts.length) {
      alert("Ø£Ø±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }

    let scr =
      "3DDOLY\n" +
      pts
        .map(p => `${p.n},${type === "design" ? p.zD.toFixed(3) : p.z.toFixed(3)}`)
        .join("\n") +
      "\n\n";

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([scr], { type: "text/plain" }));
    a.download = type + "_Sahaby.scr";
    a.click();

    speak("ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ù†Ø¬Ø§Ø­");
  }

  /* ---------------------------------------------------------
     ğŸ”· Ø§Ù„ØªÙ‚Ø§Ø· ØªÙ‚Ø±ÙŠØ± ØµÙˆØ±Ø©
     --------------------------------------------------------- */
  function generateReport() {
    html2canvas(document.getElementById("reportArea")).then(canvas => {
      const link = document.createElement("a");
      link.download = "Sahaby_Report.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  }

</script>
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محول ملفات TXT لبروفايل Civil 3D - م. محمود صحابي</title>
    
    <style>
        body { background-color: #0d0d0d; color: #ffd700; text-align: center; font-family: 'Segoe UI', sans-serif; padding: 10px; margin: 0; }
        .container { background: #1a1a1a; padding: 20px; border-radius: 20px; border: 2px solid #ffd700; max-width: 700px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        h1 { font-size: 1.6rem; color: #ffd700; margin-bottom: 5px; }
        .sub-text { color: #888; font-size: 0.85rem; margin-bottom: 20px; }
        
        /* منطقة رفع الملفات */
        .upload-section { border: 2px dashed #ffd700; padding: 30px; border-radius: 15px; margin-bottom: 20px; background: #222; cursor: pointer; }
        .upload-section:hover { background: #2a2a2a; }
        #fileInput { display: none; }

        /* منطقة رسم البروفايل الكروكي */
        .profile-canvas-container { background: #000; border: 1px solid #444; border-radius: 10px; margin: 20px 0; padding: 10px; position: relative; height: 200px; }
        canvas { width: 100%; height: 100%; }

        button { width: 100%; padding: 15px; margin: 5px 0; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-export { background-color: #28a745; color: #fff; }
        
        .points-table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.75rem; background: #111; }
        .points-table th, .points-table td { border: 1px solid #333; padding: 8px; text-align: center; }
        .points-table th { background: #ffd700; color: #000; }
    </style>
</head>
<body>

    <div class="container">
        <h1>المهندس محمود صحابي</h1>
        <div class="sub-text">معالج ملفات TXT وتحويلها إلى Profile (P,N,E,Z,D)</div>

        <div class="upload-section" onclick="document.getElementById('fileInput').click()">
            <p id="file-status">إضغط هنا لرفع ملف الـ TXT الخاص بالنقاط</p>
            <span style="font-size: 12px; color: #666;">التنسيق المطلوب: PT,N,E,Z,Desc أو PT E N Z Desc</span>
            <input type="file" id="fileInput" accept=".txt" onchange="handleFile(this)">
        </div>

        <div class="profile-canvas-container">
            <span style="position:absolute; top:5px; right:10px; color:#555; font-size:10px;">معاينة شكل الأرض الطبيعية</span>
            <canvas id="profileCanvas"></canvas>
        </div>

        <button class="btn-export" id="downloadBtn" style="display:none;" onclick="exportToCivil()">تصدير الملف الموحد للسيفيل (CSV)</button>

        <table class="points-table" id="pointsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Point</th>
                    <th>Northing</th>
                    <th>Easting</th>
                    <th>Elevation (Z)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let processedPoints = [];

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('file-status').innerText = "جاري معالجة: " + file.name;
            const reader = new FileReader();

            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                processedPoints = [];
                
                const tableBody = document.querySelector("#pointsTable tbody");
                tableBody.innerHTML = "";

                lines.forEach((line, index) => {
                    // دعم الفواصل المختلفة (فاصلة، مسافة، أو Tab)
                    const parts = line.split(/[,\s\t]+/).filter(p => p.trim() !== "");
                    if (parts.length >= 4) {
                        const pt = {
                            id: parts[0],
                            n: parseFloat(parts[1]),
                            e: parseFloat(parts[2]),
                            z: parseFloat(parts[3]),
                            desc: parts[4] || "STATION"
                        };
                        if (!isNaN(pt.z)) {
                            processedPoints.push(pt);
                            tableBody.innerHTML += `<tr><td>${pt.id}</td><td>${pt.n}</td><td>${pt.e}</td><td>${pt.z}</td></tr>`;
                        }
                    }
                });

                if (processedPoints.length > 0) {
                    document.getElementById('pointsTable').style.display = "table";
                    document.getElementById('downloadBtn').style.display = "block";
                    drawProfile();
                }
            };
            reader.readAsText(file);
        }

        function drawProfile() {
            const canvas = document.getElementById('profileCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const elevations = processedPoints.map(p => p.z);
            const minZ = Math.min(...elevations);
            const maxZ = Math.max(...elevations);
            const range = maxZ - minZ || 1;

            ctx.strokeStyle = "#ffd700";
            ctx.lineWidth = 2;
            ctx.beginPath();

            processedPoints.forEach((p, i) => {
                const x = (i / (processedPoints.length - 1)) * canvas.width;
                const y = canvas.height - ((p.z - minZ) / range) * (canvas.height - 20) - 10;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function exportToCivil() {
            let csvContent = "P,N,E,Z,D\n";
            processedPoints.forEach(p => {
                csvContent += `${p.id},${p.n},${p.e},${p.z},${p.desc}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Sahaby_Final_Profile.csv";
            link.click();
        }
    </script>
</body>
</html>
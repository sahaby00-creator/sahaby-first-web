<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ø±Ùƒ Ø§Ù„ØµØ­Ø§Ø¨ÙŠ v45.0 | Ø§Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --gold: #ffcc00; --green: #00f2fe; --blue: #00d2ff; --bg: #030508;
            --card-bg: rgba(15, 18, 25, 0.95); --red: #ff4b2b; --purple: #a18cd1;
        }

        body {
            background: var(--bg);
            background-image: radial-gradient(circle at center, #111827, #030508);
            color: white; font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; padding: 20px; min-height: 100vh;
        }

        .container {
            max-width: 1500px; margin: auto;
            background: var(--card-bg); backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9);
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.05);
            padding-bottom: 20px;
        }

        .title-area h2 {
            margin: 0; font-size: 30px; font-weight: 900;
            background: linear-gradient(to left, var(--gold), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .button-group { display: flex; gap: 10px; }
        
        .btn {
            padding: 12px 22px; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 700; font-size: 13px;
            transition: 0.3s; display: flex; align-items: center; gap: 8px; color: white;
        }

        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        .btn-up { background: #eeeeee; color: #000; }
        .btn-design { background: linear-gradient(135deg, #00b09b, #96c93d); }
        .btn-ngl { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .btn-pdf { background: linear-gradient(135deg, #6a11cb, #2575fc); border: 1px solid rgba(255,255,255,0.2); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .card {
            background: rgba(0, 0, 0, 0.7); border-radius: 15px; padding: 25px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        h4 { margin: 0 0 15px 0; color: var(--gold); font-size: 18px; border-right: 4px solid var(--gold); padding-right: 10px; }

        #map { height: 420px; border-radius: 12px; border: 1px solid #444; }
        
        .coords-panel {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
        }
        .coord-box {
            background: #111; padding: 10px; border-radius: 8px; border: 1px solid #222; font-size: 11px;
        }
        .coord-box b { color: var(--green); display: block; font-size: 14px; margin-top: 3px; font-family: monospace; }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„ÙŠÙƒÙˆÙ† Ø£ÙˆØ¶Ø­ */
        canvas { 
            width: 100%; height: 420px; background: #000; border-radius: 12px; 
            border: 1px solid #1a1a1a;
            box-shadow: inset 0 0 20px rgba(0, 242, 254, 0.05);
        }

        .table-container { grid-column: span 2; max-height: 350px; overflow-y: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { background: #0a0a0a; color: var(--gold); padding: 15px; font-size: 13px; position: sticky; top: 0; border-bottom: 2px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #1a1a1a; font-size: 12px; background: #050505; }
        .design-text { color: var(--green); font-weight: bold; text-shadow: 0 0 5px rgba(0, 242, 254, 0.3); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title-area">
            <h2>ğŸ—ï¸ Ø§Ù„Ù…Ø­Ø±Ùƒ v45.0 | Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±</h2>
            <div style="color: var(--gold); font-size: 13px; font-weight: 500; opacity: 0.8;">Ø¥Ø´Ø±Ø§Ù: Ù…. Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ - Ø£Ø®ØµØ§Ø¦ÙŠ Ù…Ø³Ø§Ø­Ø© ÙˆØªÙ‚Ø¯ÙŠØ± ÙƒÙ…ÙŠØ§Øª</div>
        </div>
        <div class="button-group">
            <button class="btn btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù NGL</button>
            <button class="btn btn-design" onclick="exportSCR('design')">âš¡ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØµÙ…ÙŠÙ…ÙŠ</button>
            <button class="btn btn-ngl" onclick="exportSCR('ngl')">âš¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø¶</button>
            <button class="btn btn-pdf" onclick="openSahabyCV()">ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</button>
        </div>
        <input type="file" id="fileIn" style="display:none" onchange="processNGL(this)">
    </div>

    <div class="grid">
        <div class="card">
            <h4>ğŸ“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‡Ø¬ÙŠÙ†Ø© (ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©)</h4>
            <div id="map"></div>
            <div class="coords-panel">
                <div class="coord-box">WGS84 (Lat/Lon): <b id="gCoord">--- , ---</b></div>
                <div class="coord-box">UTM Civil 3D (X/Y): <b id="cCoord">--- , ---</b></div>
            </div>
            <button class="btn" style="width:100%; margin-top:15px; justify-content:center; background: var(--blue);" onclick="activateGPS()">ğŸ“¡ Ø±ØµØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù„Ù…</button>
        </div>

        <div class="card">
            <h4>ğŸ“ˆ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø·ÙˆÙ„ÙŠ (Ø±Ø¤ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ÙˆØ¶ÙˆØ­)</h4>
            <canvas id="profileCanvas"></canvas>
            <div style="display: flex; gap: 20px; font-size: 11px; margin-top: 10px; justify-content: center;">
                <span style="color: var(--gold);">--- Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (NGL)</span>
                <span style="color: var(--green);">â€”â€” Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ (Design)</span>
            </div>
        </div>

        <div class="table-container card">
            <h4>ğŸ“‹ ÙƒØ´Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©</h4>
            <table>
                <thead>
                    <tr>
                        <th>#</th><th>X (Original)</th><th>Y (Original)</th><th>Z (Ground)</th>
                        <th class="design-text">X (Design)</th><th class="design-text">Y (Design)</th><th class="design-text">Z (Optimized)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" style="padding:40px; opacity:0.3; font-style: italic;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚Ù„ÙŠØ©...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let pts = [], map, marker;

    // --- Ù‚ÙˆØ© v40 Ù„ÙØªØ­ Ø§Ù„Ø³ÙŠ ÙÙŠ ---
    function openSahabyCV() {
        const win = window.open("", "_blank");
        win.document.write(`
            <body style="margin:0; background:#030508; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;">
                <h2 style="color:#ffcc00;">Ù…. Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ</h2>
                <div style="border: 3px solid #111; border-top: 3px solid #00f2fe; border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s linear infinite; box-shadow: 0 0 20px rgba(0, 242, 254, 0.2);"></div>
                <script>
                    setTimeout(() => { window.location.href = "Quantity Surveyor mahmoud ali elsayed shaby hammad.pdf"; }, 800);
                <\/script>
                <style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
            </body>
        `);
    }

    // --- Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© v40 ---
    function processNGL(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/);
            pts = lines.map((line, i) => {
                const d = line.trim().split(/[, \s\t]+/);
                if (d.length >= 3) {
                    let east = parseFloat(d[d.length-3]), north = parseFloat(d[d.length-2]), elev = parseFloat(d[d.length-1]);
                    return { id: i+1, e: east, n: north, z: elev, zD: elev, de: east, dn: north };
                }
            }).filter(p => p);
            if (pts.length) { calculateIdealPath(); updateDisplay(); }
        };
        reader.readAsText(input.files[0]);
    }

    function calculateIdealPath() {
        const windowSize = 8;
        for (let pass = 0; pass < 2; pass++) {
            pts.forEach((p, i) => {
                let win = pts.slice(Math.max(0, i - windowSize), Math.min(pts.length, i + windowSize + 1));
                p.zD = win.reduce((a, b) => a + (pass === 0 ? b.z : b.zD), 0) / win.length;
                p.de = win.reduce((a, b) => a + (pass === 0 ? b.e : b.de), 0) / win.length;
                p.dn = win.reduce((a, b) => a + (pass === 0 ? b.n : b.dn), 0) / win.length;
            });
        }
    }

    function updateDisplay() {
        document.getElementById('tableBody').innerHTML = pts.map(p => `
            <tr>
                <td>${p.id}</td><td>${p.e.toFixed(2)}</td><td>${p.n.toFixed(2)}</td><td>${p.z.toFixed(2)}</td>
                <td class="design-text">${p.de.toFixed(3)}</td><td class="design-text">${p.dn.toFixed(3)}</td><td class="design-text">${p.zD.toFixed(3)}</td>
            </tr>
        `).join('');
        drawProfile();
    }

    function drawProfile() {
        const cvs = document.getElementById('profileCanvas'), ctx = cvs.getContext('2d');
        cvs.width = cvs.offsetWidth; cvs.height = 420;
        let zs = [...pts.map(p => p.z), ...pts.map(p => p.zD)];
        let min = Math.min(...zs)-1, max = Math.max(...zs)+1, rng = max-min;
        
        // Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø®Ù„ÙÙŠØ©
        ctx.strokeStyle = "#111"; ctx.lineWidth = 1;
        for(let j=0; j<10; j++) {
            ctx.beginPath(); ctx.moveTo(0, j*42); ctx.lineTo(cvs.width, j*42); ctx.stroke();
        }

        // Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (Ø°Ù‡Ø¨ÙŠ Ù…Ù†Ù‚Ø·)
        ctx.strokeStyle = "rgba(255, 204, 0, 0.4)"; ctx.setLineDash([8,4]); ctx.lineWidth = 2; ctx.beginPath();
        pts.forEach((p, i) => {
            let x = (i/pts.length)*cvs.width, y = cvs.height - ((p.z-min)/rng)*cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }); ctx.stroke();

        // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…ÙŠ (Ø£Ø®Ø¶Ø± Ù†ÙŠÙˆÙ† Ø³Ù…ÙŠÙƒ)
        ctx.strokeStyle = "#00f2fe"; ctx.setLineDash([]); ctx.lineWidth = 6;
        ctx.shadowBlur = 15; ctx.shadowColor = "#00f2fe";
        ctx.beginPath();
        pts.forEach((p, i) => {
            let x = (i/pts.length)*cvs.width, y = cvs.height - ((p.zD-min)/rng)*cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }); ctx.stroke();
        ctx.shadowBlur = 0; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆÙ‡Ø¬ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    }

    function activateGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            if(!map) { 
                map = L.map('map').setView([latitude, longitude], 19); 
                // Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
                // Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ù… ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙƒØ«ÙØ© (Hybrid)
                L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);
                L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}').addTo(map);
            }
            if(marker) map.removeLayer(marker);
            marker = L.marker([latitude, longitude]).addTo(map).bindPopup("Ø±ØµØ¯ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ù…").openPopup();
            document.getElementById('gCoord').innerText = latitude.toFixed(7) + " , " + longitude.toFixed(7);
            document.getElementById('cCoord').innerText = "660542.067 , 2736135.38";
        });
    }

    function exportSCR(type) {
        if(!pts.length) return alert("Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
        let data = (type === 'design') ? pts.map(p => `${p.de.toFixed(3)},${p.dn.toFixed(3)}`) : pts.map(p => `${p.e.toFixed(3)},${p.n.toFixed(3)}`);
        let scr = `UNDO BE\nCOLOR ${type=='design'?3:2}\nPLINE\n${data.join("\n")}\nPEDIT L S\nZOOM E\nUNDO END\n`;
        const blob = new Blob([scr], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = type + "_Certified.scr"; a.click();
    }
</script>
</body>
</html>
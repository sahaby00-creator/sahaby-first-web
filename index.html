<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    
    <style>
        body { background-color: #0d0d0d; color: #ffd700; text-align: center; font-family: 'Segoe UI', sans-serif; padding: 10px; margin: 0; }
        .container { background: #1a1a1a; padding: 20px; border-radius: 20px; border: 2px solid #ffd700; max-width: 700px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        h1 { font-size: 1.6rem; color: #ffd700; margin: 0; }
        .section-title { background: #333; padding: 8px; border-radius: 8px; margin: 20px 0 10px 0; font-size: 0.9rem; color: #fff; border-right: 4px solid #ffd700; text-align: right; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­ÙŠ */
        .live-coords { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .coord-card { background: #262626; padding: 10px; border-radius: 10px; border: 1px solid #444; }
        .label { display: block; color: #888; font-size: 0.7rem; }
        .val { color: #fff; font-family: monospace; font-size: 1rem; font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø±Ø³Ù… */
        .upload-area { border: 2px dashed #ffd700; padding: 20px; border-radius: 15px; background: #222; cursor: pointer; margin-bottom: 15px; }
        .canvas-box { background: #000; height: 180px; border-radius: 10px; margin: 15px 0; border: 1px solid #333; }
        canvas { width: 100%; height: 100%; }

        button { width: 100%; padding: 14px; margin: 5px 0; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-gps { background-color: #ffd700; color: #000; }
        .btn-export { background-color: #28a745; color: #fff; }
        
        .map-frame { height: 200px; border-radius: 15px; overflow: hidden; margin-top: 10px; border: 1px solid #444; }
        iframe { width: 100%; height: 100%; border: none; }

        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 15px; background: #111; }
        th, td { border: 1px solid #333; padding: 6px; text-align: center; }
        th { background: #ffd700; color: #000; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…ÙˆØ¯ ØµØ­Ø§Ø¨ÙŠ</h1>
        <p style="color:#888; font-size: 0.8rem;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ Ùˆ Civil 3D - Ø§Ù„Ø±ÙŠØ§Ø¶</p>

        <div class="section-title">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS & Civil 3D)</div>
        <div class="live-coords">
            <div class="coord-card"><span class="label">Northing (N)</span><div class="val" id="live-n">0.000</div></div>
            <div class="coord-card"><span class="label">Easting (E)</span><div class="val" id="live-e">0.000</div></div>
            <div class="coord-card"><span class="label">Latitude</span><div class="val" id="live-lat">0.000000</div></div>
            <div class="coord-card"><span class="label">Longitude</span><div class="val" id="live-lon">0.000000</div></div>
        </div>
        <button class="btn-gps" onclick="getLiveLocation()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ğŸ“¡</button>
        <div class="map-frame" id="mapView">
            <p style="padding-top: 80px; color:#444;">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
        </div>

        <div class="section-title">ğŸ“ˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª TXT ÙˆØ±Ø³Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
        <div class="upload-area" onclick="document.getElementById('fileIn').click()">
            <p id="status">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù TXT (Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)</p>
            <input type="file" id="fileIn" style="display:none" onchange="processTxt(this)">
        </div>

        <div class="canvas-box">
            <canvas id="profileChart"></canvas>
        </div>

        <button class="btn-export" id="dlBtn" style="display:none" onclick="downloadFinalCSV()">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø³ÙŠÙÙŠÙ„ (CSV)</button>

        <table id="dataTable" style="display:none">
            <thead><tr><th>PT</th><th>N</th><th>E</th><th>Z (Elevation)</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let filePoints = [];

        // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­ÙŠ
        function getLiveLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    let lat = p.coords.latitude;
                    let lon = p.coords.longitude;
                    // ØªØ­ÙˆÙŠÙ„ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø³ÙŠÙÙŠÙ„ (ÙƒÙ…Ø§ ÙÙŠ Ø®Ø·ÙˆØ§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
                    let n = (lat * 111000).toFixed(3);
                    let e = (lon * 100000).toFixed(3);

                    document.getElementById('live-n').innerText = n;
                    document.getElementById('live-e').innerText = e;
                    document.getElementById('live-lat').innerText = lat.toFixed(6);
                    document.getElementById('live-lon').innerText = lon.toFixed(6);

                    const mapUrl = `https://maps.google.com/maps?q=${lat},${lon}&z=17&output=embed`;
                    document.getElementById('mapView').innerHTML = `<iframe src="${mapUrl}"></iframe>`;
                }, null, {enableHighAccuracy: true});
            }
        }

        // ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù
        function processTxt(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/);
                filePoints = [];
                const tbody = document.querySelector("#dataTable tbody");
                tbody.innerHTML = "";

                lines.forEach(line => {
                    const parts = line.split(/[,\s\t]+/).filter(i => i.trim() !== "");
                    if (parts.length >= 4) {
                        const pt = { id: parts[0], n: parts[1], e: parts[2], z: parseFloat(parts[3]) };
                        if (!isNaN(pt.z)) {
                            filePoints.push(pt);
                            tbody.innerHTML += `<tr><td>${pt.id}</td><td>${pt.n}</td><td>${pt.e}</td><td>${pt.z}</td></tr>`;
                        }
                    }
                });
                if (filePoints.length > 0) {
                    document.getElementById('dataTable').style.display = "table";
                    document.getElementById('dlBtn').style.display = "block";
                    document.getElementById('status').innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: " + file.name;
                    drawCanvas();
                }
            };
            reader.readAsText(file);
        }

        function drawCanvas() {
            const canvas = document.getElementById('profileChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const elevations = filePoints.map(p => p.z);
            const min = Math.min(...elevations);
            const max = Math.max(...elevations);
            const range = max - min || 1;

            ctx.strokeStyle = "#ffd700";
            ctx.lineWidth = 3;
            ctx.beginPath();
            filePoints.forEach((p, i) => {
                const x = (i / (filePoints.length - 1)) * canvas.width;
                const y = canvas.height - ((p.z - min) / range) * (canvas.height - 40) - 20;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function downloadFinalCSV() {
            let csv = "P,N,E,Z,D\n";
            filePoints.forEach(p => csv += `${p.id},${p.n},${p.e},${p.z},SAHABY_PROF\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Sahaby_Full_Data.csv";
            a.click();
        }
        
        window.onload = getLiveLocation; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    </script>
</body>
</html>